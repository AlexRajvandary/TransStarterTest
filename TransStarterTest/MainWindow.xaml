<Window x:Class="TransStarterTest.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:TransStarterTest"
        xmlns:enum="clr-namespace:TransStarterTest.Models.Enums"
        xmlns:converters="clr-namespace:TransStarterTest.Converters"
        xmlns:sys="clr-namespace:System;assembly=mscorlib"
        xmlns:attachedBehaviors="clr-namespace:TransStarterTest.Behaviors"
        mc:Ignorable="d"
        Title="MainWindow" Height="500" Width="900">
    <Window.Resources>
        <converters:EnumDescriptionConverter x:Key="EnumDescConverter"/>
        <converters:HighlightCellConverter x:Key="HighlightCellConverter"/>

        <!-- Значения для ComboBox-ов режима и настроект группировки/аггрегирования -->
        <ObjectDataProvider MethodName="GetValues" 
                            ObjectType="{x:Type sys:Enum}" 
                            x:Key="ReportViewModeValues">
            <ObjectDataProvider.MethodParameters>
                <x:Type TypeName="enum:ReportViewMode"/>
            </ObjectDataProvider.MethodParameters>
        </ObjectDataProvider>

        <ObjectDataProvider MethodName="GetValues"
                            ObjectType="{x:Type sys:Enum}"
                            x:Key="GroupingOptionsValues">
            <ObjectDataProvider.MethodParameters>
                <x:Type TypeName="enum:GroupingOptions"/>
            </ObjectDataProvider.MethodParameters>
        </ObjectDataProvider>

        <ObjectDataProvider MethodName="GetValues" 
              ObjectType="{x:Type sys:Enum}" 
              x:Key="AggregateOptionsValues">
            <ObjectDataProvider.MethodParameters>
                <x:Type TypeName="enum:AggregateOptions"/>
            </ObjectDataProvider.MethodParameters>
        </ObjectDataProvider>

        <DataTemplate x:Key="EnumItemTemplate">
            <TextBlock Text="{Binding Converter={StaticResource EnumDescConverter}}"/>
        </DataTemplate>
    </Window.Resources>

    <Grid Margin="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <TextBlock Text="Car Sales Dashboard" 
                   FontSize="24" 
                   FontWeight="Bold" 
                   HorizontalAlignment="Center" 
                   Margin="0,0,0,10"/>

        <TabControl Grid.Row="1" 
                    x:Name="MainTabControl"
                    ItemsSource="{Binding Tabs}" 
                    SelectedItem="{Binding SelectedTab}">
            <TabControl.ItemTemplate>
                <DataTemplate>
                    <TextBlock Text="{Binding Title}" />
                </DataTemplate>
            </TabControl.ItemTemplate>

            <TabControl.ContentTemplate>
                <DataTemplate>
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <!-- Панель фильтров -->
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                            <TextBlock Text="Режим:" VerticalAlignment="Center" Margin="0,0,5,0"/>
                            <ComboBox Width="120"
                                      ItemsSource="{Binding Source={StaticResource ReportViewModeValues}}"
                                      SelectedItem="{Binding ViewMode}"
                                      ItemTemplate="{StaticResource EnumItemTemplate}"
                                      />
                            <CheckBox IsChecked="{Binding SalesHighlightSettings.IsEnabled}"/>
                            <TextBox Text="{Binding SalesHighlightSettings.Threshold}"/>

                            <!-- Параметры только для Pivot -->
                            <StackPanel Orientation="Horizontal" Margin="10,0,0,0">
                                <StackPanel.Style>
                                    <Style TargetType="StackPanel">
                                        <Setter Property="Visibility" Value="Collapsed"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding ViewMode}" Value="Pivot">
                                                <Setter Property="Visibility" Value="Visible"/>
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding ViewMode}" Value="DynamicPivot">
                                                <Setter Property="Visibility" Value="Visible"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </StackPanel.Style>

                                <TextBlock Text="Группировка:" VerticalAlignment="Center" Margin="0,0,5,0"/>
                                <ComboBox Width="120"
                                          ItemsSource="{Binding Source={StaticResource GroupingOptionsValues}}"
                                          SelectedItem="{Binding ReportSettings.GroupBy}"
                                          ItemTemplate="{StaticResource EnumItemTemplate}"
                                          />

                                <TextBlock Text="Агрегат:" VerticalAlignment="Center" Margin="10,0,5,0"/>
                                <ComboBox Width="120"
                                          ItemsSource="{Binding Source={StaticResource AggregateOptionsValues}}"
                                          SelectedItem="{Binding ReportSettings.AggregateBy}"
                                          ItemTemplate="{StaticResource EnumItemTemplate}"
                                          />

                                <TextBlock Text="Год:" VerticalAlignment="Center" Margin="10,0,5,0"/>
                                <ComboBox Width="100"
                                          ItemsSource="{Binding AvailableYears}"
                                          SelectedItem="{Binding ReportSettings.YearFilter}"/>
                            </StackPanel>
                        </StackPanel>

                        <!-- Обычный режим -->
                        <DataGrid Grid.Row="1"
                                  x:Name="SalesGrid"
                                  ItemsSource="{Binding ReportData}"
                                  IsReadOnly="True"
                                  AutoGenerateColumns="False"
                                  EnableRowVirtualization="True"
                                  EnableColumnVirtualization="True"
                                  VirtualizingPanel.IsVirtualizing="True"
                                  VirtualizingPanel.VirtualizationMode="Recycling">
                            <DataGrid.Style>
                                <Style TargetType="DataGrid">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding ViewMode}" Value="Details">
                                            <Setter Property="Visibility" Value="Visible"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </DataGrid.Style>

                            <DataGrid.Columns>
                                <DataGridTextColumn Header="Дата" Binding="{Binding Date, StringFormat=dd/MM/yyyy}"/>
                                <DataGridTextColumn Header="Покупатель" Binding="{Binding CustomerFullName}"/>
                                <DataGridTextColumn Header="Бренд" Binding="{Binding BrandName}"/>
                                <DataGridTextColumn Header="Модель" Binding="{Binding ModelName}"/>
                                <DataGridTextColumn Header="Цена" Binding="{Binding Price, StringFormat={}{0:N0}, ConverterCulture=ru-RU}">
                                    <DataGridTextColumn.CellStyle>
                                        <Style TargetType="DataGridCell">
                                            <Setter Property="Background">
                                                <Setter.Value>
                                                    <MultiBinding Converter="{StaticResource HighlightCellConverter}">
                                                        <Binding Path="Price"/>
                                                        <Binding Path="DataContext.SalesHighlightSettings.Threshold" ElementName="SalesGrid"/>
                                                        <Binding Path="DataContext.SalesHighlightSettings.IsEnabled" ElementName="SalesGrid"/>
                                                    </MultiBinding>
                                                </Setter.Value>
                                            </Setter>
                                        </Style>
                                    </DataGridTextColumn.CellStyle>
                                </DataGridTextColumn>
                            </DataGrid.Columns>
                        </DataGrid>

                        <!-- Pivot режим -->
                        <DataGrid Grid.Row="1"
                                  x:Name="PivotGrid"
                                  ItemsSource="{Binding Pivot.Rows}"
                                  CanUserAddRows="False"
                                  CanUserDeleteRows="False"
                                  IsReadOnly="True"
                                  AutoGenerateColumns="False"
                                  EnableRowVirtualization="True"
                                  EnableColumnVirtualization="True"
                                  VirtualizingPanel.IsVirtualizing="True"
                                  VirtualizingPanel.VirtualizationMode="Recycling">
                          
                            <DataGrid.Style>
                                <Style TargetType="DataGrid">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding ViewMode}" Value="Pivot">
                                            <Setter Property="Visibility" Value="Visible"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </DataGrid.Style>

                            <DataGrid.Columns>
                                <DataGridTextColumn Header="Группа" Binding="{Binding RowKey}"/>

                                <DataGridTextColumn Header="Январь" Binding="{Binding January, StringFormat={}{0:N0}, ConverterCulture=ru-RU}">
                                    <DataGridTextColumn.CellStyle>
                                        <Style TargetType="DataGridCell">
                                            <Setter Property="Background">
                                                <Setter.Value>
                                                    <MultiBinding Converter="{StaticResource HighlightCellConverter}">
                                                        <Binding Path="January"/>
                                                        <Binding Path="DataContext.SalesHighlightSettings.Threshold" ElementName="PivotGrid"/>
                                                        <Binding Path="DataContext.SalesHighlightSettings.IsEnabled" ElementName="PivotGrid"/>
                                                    </MultiBinding>
                                                </Setter.Value>
                                            </Setter>
                                        </Style>
                                    </DataGridTextColumn.CellStyle>
                                </DataGridTextColumn>
                                <DataGridTextColumn Header="Февраль" Binding="{Binding Febuary, StringFormat={}{0:N0}, ConverterCulture=ru-RU}">
                                    <DataGridTextColumn.CellStyle>
                                        <Style TargetType="DataGridCell">
                                            <Setter Property="Background">
                                                <Setter.Value>
                                                    <MultiBinding Converter="{StaticResource HighlightCellConverter}">
                                                        <Binding Path="Febuary"/>
                                                        <Binding Path="DataContext.SalesHighlightSettings.Threshold" ElementName="PivotGrid"/>
                                                        <Binding Path="DataContext.SalesHighlightSettings.IsEnabled" ElementName="PivotGrid"/>
                                                    </MultiBinding>
                                                </Setter.Value>
                                            </Setter>
                                        </Style>
                                    </DataGridTextColumn.CellStyle>
                                </DataGridTextColumn>
                                <DataGridTextColumn Header="Март" Binding="{Binding March, StringFormat={}{0:N0}, ConverterCulture=ru-RU}">
                                    <DataGridTextColumn.CellStyle>
                                        <Style TargetType="DataGridCell">
                                            <Setter Property="Background">
                                                <Setter.Value>
                                                    <MultiBinding Converter="{StaticResource HighlightCellConverter}">
                                                        <Binding Path="March"/>
                                                        <Binding Path="DataContext.SalesHighlightSettings.Threshold" ElementName="PivotGrid"/>
                                                        <Binding Path="DataContext.SalesHighlightSettings.IsEnabled" ElementName="PivotGrid"/>
                                                    </MultiBinding>
                                                </Setter.Value>
                                            </Setter>
                                        </Style>
                                    </DataGridTextColumn.CellStyle>
                                </DataGridTextColumn>
                                <DataGridTextColumn Header="Апрель" Binding="{Binding April, StringFormat={}{0:N0}, ConverterCulture=ru-RU}">
                                    <DataGridTextColumn.CellStyle>
                                        <Style TargetType="DataGridCell">
                                            <Setter Property="Background">
                                                <Setter.Value>
                                                    <MultiBinding Converter="{StaticResource HighlightCellConverter}">
                                                        <Binding Path="April"/>
                                                        <Binding Path="DataContext.SalesHighlightSettings.Threshold" ElementName="PivotGrid"/>
                                                        <Binding Path="DataContext.SalesHighlightSettings.IsEnabled" ElementName="PivotGrid"/>
                                                    </MultiBinding>
                                                </Setter.Value>
                                            </Setter>
                                        </Style>
                                    </DataGridTextColumn.CellStyle>
                                </DataGridTextColumn>
                                <DataGridTextColumn Header="Май" Binding="{Binding May, StringFormat={}{0:N0}, ConverterCulture=ru-RU}">
                                    <DataGridTextColumn.CellStyle>
                                        <Style TargetType="DataGridCell">
                                            <Setter Property="Background">
                                                <Setter.Value>
                                                    <MultiBinding Converter="{StaticResource HighlightCellConverter}">
                                                        <Binding Path="May"/>
                                                        <Binding Path="DataContext.SalesHighlightSettings.Threshold" ElementName="PivotGrid"/>
                                                        <Binding Path="DataContext.SalesHighlightSettings.IsEnabled" ElementName="PivotGrid"/>
                                                    </MultiBinding>
                                                </Setter.Value>
                                            </Setter>
                                        </Style>
                                    </DataGridTextColumn.CellStyle>
                                </DataGridTextColumn>
                                <DataGridTextColumn Header="Июнь" Binding="{Binding June, StringFormat={}{0:N0}, ConverterCulture=ru-RU}">
                                    <DataGridTextColumn.CellStyle>
                                        <Style TargetType="DataGridCell">
                                            <Setter Property="Background">
                                                <Setter.Value>
                                                    <MultiBinding Converter="{StaticResource HighlightCellConverter}">
                                                        <Binding Path="June"/>
                                                        <Binding Path="DataContext.SalesHighlightSettings.Threshold" ElementName="PivotGrid"/>
                                                        <Binding Path="DataContext.SalesHighlightSettings.IsEnabled" ElementName="PivotGrid"/>
                                                    </MultiBinding>
                                                </Setter.Value>
                                            </Setter>
                                        </Style>
                                    </DataGridTextColumn.CellStyle>
                                </DataGridTextColumn>
                                <DataGridTextColumn Header="Июль" Binding="{Binding July, StringFormat={}{0:N0}, ConverterCulture=ru-RU}">
                                    <DataGridTextColumn.CellStyle>
                                        <Style TargetType="DataGridCell">
                                            <Setter Property="Background">
                                                <Setter.Value>
                                                    <MultiBinding Converter="{StaticResource HighlightCellConverter}">
                                                        <Binding Path="July"/>
                                                        <Binding Path="DataContext.SalesHighlightSettings.Threshold" ElementName="PivotGrid"/>
                                                        <Binding Path="DataContext.SalesHighlightSettings.IsEnabled" ElementName="PivotGrid"/>
                                                    </MultiBinding>
                                                </Setter.Value>
                                            </Setter>
                                        </Style>
                                    </DataGridTextColumn.CellStyle>
                                </DataGridTextColumn>
                                <DataGridTextColumn Header="Август" Binding="{Binding August, StringFormat={}{0:N0}, ConverterCulture=ru-RU}">
                                    <DataGridTextColumn.CellStyle>
                                        <Style TargetType="DataGridCell">
                                            <Setter Property="Background">
                                                <Setter.Value>
                                                    <MultiBinding Converter="{StaticResource HighlightCellConverter}">
                                                        <Binding Path="August"/>
                                                        <Binding Path="DataContext.SalesHighlightSettings.Threshold" ElementName="PivotGrid"/>
                                                        <Binding Path="DataContext.SalesHighlightSettings.IsEnabled" ElementName="PivotGrid"/>
                                                    </MultiBinding>
                                                </Setter.Value>
                                            </Setter>
                                        </Style>
                                    </DataGridTextColumn.CellStyle>
                                </DataGridTextColumn>
                                <DataGridTextColumn Header="Сентябрь" Binding="{Binding September, StringFormat={}{0:N0}, ConverterCulture=ru-RU}">
                                    <DataGridTextColumn.CellStyle>
                                        <Style TargetType="DataGridCell">
                                            <Setter Property="Background">
                                                <Setter.Value>
                                                    <MultiBinding Converter="{StaticResource HighlightCellConverter}">
                                                        <Binding Path="September"/>
                                                        <Binding Path="DataContext.SalesHighlightSettings.Threshold" ElementName="PivotGrid"/>
                                                        <Binding Path="DataContext.SalesHighlightSettings.IsEnabled" ElementName="PivotGrid"/>
                                                    </MultiBinding>
                                                </Setter.Value>
                                            </Setter>
                                        </Style>
                                    </DataGridTextColumn.CellStyle>
                                </DataGridTextColumn>
                                <DataGridTextColumn Header="Октябрь" Binding="{Binding October, StringFormat={}{0:N0}, ConverterCulture=ru-RU}">
                                    <DataGridTextColumn.CellStyle>
                                        <Style TargetType="DataGridCell">
                                            <Setter Property="Background">
                                                <Setter.Value>
                                                    <MultiBinding Converter="{StaticResource HighlightCellConverter}">
                                                        <Binding Path="October"/>
                                                        <Binding Path="DataContext.SalesHighlightSettings.Threshold" ElementName="PivotGrid"/>
                                                        <Binding Path="DataContext.SalesHighlightSettings.IsEnabled" ElementName="PivotGrid"/>
                                                    </MultiBinding>
                                                </Setter.Value>
                                            </Setter>
                                        </Style>
                                    </DataGridTextColumn.CellStyle>
                                </DataGridTextColumn>
                                <DataGridTextColumn Header="Ноябрь" Binding="{Binding November, StringFormat={}{0:N0}, ConverterCulture=ru-RU}">
                                    <DataGridTextColumn.CellStyle>
                                        <Style TargetType="DataGridCell">
                                            <Setter Property="Background">
                                                <Setter.Value>
                                                    <MultiBinding Converter="{StaticResource HighlightCellConverter}">
                                                        <Binding Path="November"/>
                                                        <Binding Path="DataContext.SalesHighlightSettings.Threshold" ElementName="PivotGrid"/>
                                                        <Binding Path="DataContext.SalesHighlightSettings.IsEnabled" ElementName="PivotGrid"/>
                                                    </MultiBinding>
                                                </Setter.Value>
                                            </Setter>
                                        </Style>
                                    </DataGridTextColumn.CellStyle>
                                </DataGridTextColumn>
                                <DataGridTextColumn Header="Декабрь" Binding="{Binding December, StringFormat={}{0:N0}, ConverterCulture=ru-RU}">
                                    <DataGridTextColumn.CellStyle>
                                        <Style TargetType="DataGridCell">
                                            <Setter Property="Background">
                                                <Setter.Value>
                                                    <MultiBinding Converter="{StaticResource HighlightCellConverter}">
                                                        <Binding Path="December"/>
                                                        <Binding Path="DataContext.SalesHighlightSettings.Threshold" ElementName="PivotGrid"/>
                                                        <Binding Path="DataContext.SalesHighlightSettings.IsEnabled" ElementName="PivotGrid"/>
                                                    </MultiBinding>
                                                </Setter.Value>
                                            </Setter>
                                        </Style>
                                    </DataGridTextColumn.CellStyle>
                                </DataGridTextColumn>

                            </DataGrid.Columns>
                        </DataGrid>

                        <!-- Dynamic Pivot режим -->
                        <DataGrid x:Name="DynamicPivotGrid"
                                  ItemsSource="{Binding DynamicPivot.Test}"
                                  attachedBehaviors:DataGridColumnsBehavior.BindableColumns="{Binding ColumnDefinitions}"
                            Grid.Row="1"
                            AutoGenerateColumns="False"
                            EnableRowVirtualization="True"
                            EnableColumnVirtualization="True"
                            VirtualizingPanel.IsVirtualizing="True"
                            VirtualizingPanel.VirtualizationMode="Recycling">

                            <DataGrid.Style>
                                <Style TargetType="DataGrid">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding ViewMode}" Value="DynamicPivot">
                                            <Setter Property="Visibility" Value="Visible"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </DataGrid.Style>

                        </DataGrid>
                    </Grid>
                </DataTemplate>
            </TabControl.ContentTemplate>
        </TabControl>

        <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,10,0,0">
            <Button Content="Добавить отчет" Width="150" Height="30" Margin="0,0,10,0" Command="{Binding AddTabCommand}"/>
            <Button Content="Export to Excel" Width="150" Height="30" Command="{Binding ExportCommand}"/>
        </StackPanel>
    </Grid>
</Window>
